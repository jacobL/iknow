<!DOCTYPE html>
<html style="height: 100%"> 
<head>
<title>IKnow chat log</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="">
<meta name="author" content="">
<script src="http://smartdoe.cminl.oa/launchChrome.js?v=1811140812"></script> 
 
<script src="../js/coq/3.1.1/jquery.js"></script> 
 
<script src="../js/coq/bootstrap.bundle.min.js"></script>
 
<script src="../js/coq/lodash.js"></script>
<script src="../js/coq/jszip.min.js"></script>
<script src="../js/coq/excel-builder.dist.js"></script>
<link href="../css/coq/bootstrap.min.css" rel="stylesheet">  
 
<style>
body {
  line-height:1.2
}
.chart {
  width: 100%;
  height: 100%;
}

.card {
  border: 0px;
}
.card-body{
  padding: 0px
}
.col-md-4, .col-md-8 {
  padding-right: 0px;
  padding-left: 0px
}

#fixed_table #fix_head{
background: #FFFFFF;
box-shadow: 0px 0px 5px #888888;
</style> 


<script type="text/javascript"> 
var ajaxUrlPort = '10.55.8.201:84';
//var ajaxUrlPort = '127.0.0.1:83';//桌機 
var currentPath = window.location.href.includes("?") ? window.location.href.substring(0,window.location.href.lastIndexOf('?')) : window.location.href;
var currentPage = window.location.pathname.substring(window.location.pathname.lastIndexOf('/') + 1);
var ssoUrl = "http://10.55.8.201:83/Publish/api/SSO";

var ip = '';
var uiLog = [];
var uiLogTmp = {};

function changeGraph(graph){ 	
	//logit("changeGraph",graph);
	//saveLog();
	var app = $("#app").html();
	if(graph == 'BU月圖'){
		window.location.replace("bu.htm");
	}else if(graph == 'OU月圖'){
		window.location.replace("ou.htm");
	}else if(graph == '預計損失圖'){
		window.location.replace("aerb.htm");
	}else if(graph == 'BU堆疊年度趨勢圖'){
		window.location.replace("year.htm");
	}else if(graph == '3D年度趨勢圖'){
		window.location.replace("buyear.htm");
	}		
}
function changeItem(id,text){	 
	if(id == 'y_start'){
		text = '開始 '+text
	}	
	if(id == 'y_end'){
		text = '結束 '+text
	}	
	$('#'+id).html(text) 
	search();
}
var searchCount = 0; 
$(document).ready(function() {  
	var query = window.location.search.substring(1);
	var qs = parse_query_string(query);
	//SSO 取得User資料
	var helloContent = '';
	if (qs['userChineseName'] !== undefined){
		userChineseName = qs['userChineseName'];
		PERNR = qs['PERNR']; 
		console.log(userChineseName+' '+PERNR )
		window.history.replaceState({}, document.title, window.location.pathname);		
	}else{
		window.location.href = ssoUrl+"?redirectUrl="+currentPath;
	}
	//setInterval("saveLog();", 5000);
	search();
});	

function search(){ 
	$.ajax({ 
		url: "http://"+ajaxUrlPort+"/getChatLog",	
		type: "GET",
		dataType: 'json',
		//data:{ym_start:ym_start, ym_end:ym_end},
		contentType: "application/json; charset=utf-8",
		success: function (data) {
			console.log(data)  
			var tbody = '';
			if(Object.keys(data).length > 0){	 
				for(i = 0 ; i < Object.keys(data).length ; i++){
					
					tbody = tbody+'<tr class="row100">';
					no = i+1;
					 
					id = decodeURIComponent(data[i]['id']);
					PERNR = decodeURIComponent(data[i]['PERNR']); 
					chat = decodeURIComponent(data[i]['chat']);
					
					if(decodeURIComponent(data[i]['checktime']) != 'null'){
						checktime = decodeURIComponent(data[i]['checktime'])
						Y = new Date(checktime).getFullYear();
						M = new Date(checktime).getMonth()+1;
						D = new Date(checktime).getDate();
						h = new Date(checktime).getUTCHours();
						m = new Date(checktime).getMinutes();
						s = new Date(checktime).getSeconds();
						checktime = Y+'-'+M+'-'+D+' '+h+':'+m+':'+s;
					}else checktime = '';
					 
					
					status = decodeURIComponent(data[i]['status'])!= 'null'?decodeURIComponent(data[i]['status']):'';
					sessionsId = decodeURIComponent(data[i]['sessionsId'])!= 'null'?decodeURIComponent(data[i]['sessionsId']):'';
                    //answerType = decodeURIComponent(data[i]['answerType'])!= 'null'?decodeURIComponent(data[i]['answerType']):'';
					if(decodeURIComponent(data[i]['answerType']) == 0) answerType = '一般式';
					else if(decodeURIComponent(data[i]['answerType']) == 1) answerType = '引導式';
					else answerType = '';
					app = decodeURIComponent(data[i]['app'])!= 'null'?decodeURIComponent(data[i]['app']):'';	
					yearmonth = decodeURIComponent(data[i]['yearmonth'])!= 'null'?decodeURIComponent(data[i]['yearmonth']):'';	
					answerNo = decodeURIComponent(data[i]['answerNo'])!= 'null'?decodeURIComponent(data[i]['answerNo']):'';	
					//feedback = decodeURIComponent(data[i]['feedback'])!= 'null'?decodeURIComponent(data[i]['feedback']):'';	
					if(decodeURIComponent(data[i]['feedback']) == 0) feedback = '正確答案';
					else if(decodeURIComponent(data[i]['feedback']) == 1) feedback = '答非所問';
					else if(decodeURIComponent(data[i]['feedback']) == 2) feedback = '未回饋';
					else feedback = '';
					feedbackText = decodeURIComponent(data[i]['feedbackText'])!= 'null'?decodeURIComponent(data[i]['feedbackText']):'';
					
					lead1 = decodeURIComponent(data[i]['lead1'])!= 'null'?decodeURIComponent(data[i]['lead1']):'';	 
					lead2 = decodeURIComponent(data[i]['lead2'])!= 'null'?decodeURIComponent(data[i]['lead2']):'';	
					lead3 = decodeURIComponent(data[i]['lead3'])!= 'null'?decodeURIComponent(data[i]['lead3']):'';	
					answerText = data[i]['answerText']!= null? data[i]['answerText'] :'';						 
					userChineseName = decodeURIComponent(data[i]['userChineseName'])!= 'null'?decodeURIComponent(data[i]['userChineseName']):'';	
					 
					 
					tbody = tbody+'<td class="" style="max-width:70px;min-width:70px;" title="'+id+'">'+no+'</td>'
					tbody = tbody+'<td class="" style="max-width:100px;min-width:100px;">'+PERNR+'</td>'
					tbody = tbody+'<td class="" style="max-width:100px;min-width:100px;">'+userChineseName+'</td>'					
					tbody = tbody+'<td class="" style="max-width:300px;min-width:300px;">'+chat+'</td>'
					tbody = tbody+'<td class="" style="max-width:120px;min-width:120px;">'+checktime+'</td>'
					tbody = tbody+'<td class="" style="max-width:115px;min-width:135px;">'+sessionsId+'</td>'
					tbody = tbody+'<td class="" style="max-width:120px;min-width:120px;">'+answerType+'</td>'
					tbody = tbody+'<td class="" style="max-width:80px;min-width:100px;">'+app+'</td>'
					tbody = tbody+'<td class="" style="max-width:110px;min-width:110px;">'+yearmonth+'</td>'
					tbody = tbody+'<td class="" style="max-width:110px;min-width:110px;">'+answerNo+'</td>'
					tbody = tbody+'<td class="" style="max-width:100px;min-width:100px;">'+feedback+'</td>'
					tbody = tbody+'<td class="" style="max-width:100px;min-width:140px;">'+feedbackText+'</td>'					
					tbody = tbody+'<td class="" style="max-width:110px;min-width:110px;">'+lead1+'</td>'
					tbody = tbody+'<td class="" style="max-width:110px;min-width:110px;">'+lead2+'</td>'
					tbody = tbody+'<td class="" style="max-width:110px;min-width:110px;">'+lead3+'</td>'
					tbody = tbody+'<td class="" style="max-width:220px;min-width:350px;">'+answerText+'</td>' 
					tbody = tbody+'</tr>';					
				}								
			}else{
				$("#downloadSearch").hide();
			}	
			$('#tbody').html(tbody);			 
		},				
		error: function(xhr) {
		  alert('Ajax request 發生錯誤:'+JSON.stringify(xhr)); 
		}
	});
} 

 						 	 	 	 	 													
 
 
 
function logit(category,event){
	uiLogTmp = {};
	uiLogTmp["category"] = category;
	uiLogTmp["event"] = event;
	uiLogTmp["ct"] = Math.round(new Date().getTime()/1000);		
	uiLog.push(uiLogTmp);
}
/*
function saveLog(){ 
	if(uiLog.length > 2){
		$.ajax({ 
			url: "http://"+ajaxUrlPort+"/saveLog",	
			type: "GET",
			dataType: 'json',
			data:  {uiLog:JSON.stringify(uiLog)} ,
			contentType: "application/json; charset=utf-8",
			traditional: true,
			success: function (data) { 
				 uiLog.splice(2, uiLog.length);
				 //console.log('after saveLog uiLog:');
				 //console.log(uiLog);
			},				
			error: function(xhr) {
			  alert('Ajax request 發生錯誤:'+JSON.stringify(xhr));
			}
		}); 	
		 
	}
}*/
	/*
$.ajax({ 
	url: "http://"+ajaxUrlPort+"/getWatermark",	
	type: "GET",
	dataType: 'json',
	data:{},
	contentType: "application/json; charset=utf-8",
	success: function (data) {
		watermark = data['watermark'];
		iptmp = watermark.split("<br>");
		ip = iptmp[1];
		uiLogTmp = {};
		uiLogTmp["ip"] = ip;
		uiLogTmp["ct"] = Math.round(new Date().getTime()/1000);						
		uiLog.push(uiLogTmp);
				
		uiLogTmp = {};
		uiLogTmp["page"] = "editmessageboard";
		uiLog.push(uiLogTmp); 		 
	},				
	error: function(xhr) {
	  alert('Ajax request 發生錯誤:'+JSON.stringify(xhr));
	}
});		*/

var myclose = false;

function ConfirmClose()
{
    if (event.clientY < 0)
    {
        event.returnValue = 'You have closed the browser. Do you want to logout from your application?';
        setTimeout('myclose=false',10);
        myclose=true;
    }
}

function HandleOnClose()
{
    if (myclose==true) 
    {
        //the url of your logout page which invalidate session on logout 
        location.replace('/contextpath/j_spring_security_logout') ;
    }   
} 
</script>
</head>
 <body onbeforeunload="ConfirmClose()" onunload="HandleOnClose()"> 

	<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top" style="padding: .0rem 1rem;">
      <div class="container">
        <a class="navbar-brand" href="#"><font color="#FFD700">I-Know</font></a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <!--div class="collapse navbar-collapse" id="navbarResponsive" >
          <ul class="navbar-nav ">
            <li class="nav-item dropdown">              
			  <a class="nav-link dropdown-toggle active" href="#" id="graph" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">AERB異常事件費用管理</a>
			  <div class="dropdown-menu shadow border-0 " aria-labelledby="graph">
				   	
              </div>
            </li>	
			<li class="nav-item dropdown">              
			  <a class="nav-link dropdown-toggle active" href="#" id="y_start" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">開始 2019</a>
			  <div class="dropdown-menu shadow border-0 " aria-labelledby="y_start">
				  <span class="dropdown-item" onclick="changeItem('y_start','2017')">2017</span>
				  <span class="dropdown-item" onclick="changeItem('y_start','2018')">2018</span>
				  <span class="dropdown-item" onclick="changeItem('y_start','2019')">2019</span> 
              </div>			  
            </li>
			<li class="nav-item dropdown">              
			  <a class="nav-link dropdown-toggle active" href="#" id="m_start" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">04</a>
			  <div class="dropdown-menu shadow border-0 " aria-labelledby="m_start">
				  <span class="dropdown-item" onclick="changeItem('m_start','01')">01</span>
				  <span class="dropdown-item" onclick="changeItem('m_start','02')">02</span>
				  <span class="dropdown-item" onclick="changeItem('m_start','03')">03</span>
				  <span class="dropdown-item" onclick="changeItem('m_start','04')">04</span>
				  <span class="dropdown-item" onclick="changeItem('m_start','05')">05</span>
				  <span class="dropdown-item" onclick="changeItem('m_start','06')">06</span>
				  <span class="dropdown-item" onclick="changeItem('m_start','07')">07</span>
				  <span class="dropdown-item" onclick="changeItem('m_start','08')">08</span>
				  <span class="dropdown-item" onclick="changeItem('m_start','09')">09</span>
				  <span class="dropdown-item" onclick="changeItem('m_start','10')">10</span>
				  <span class="dropdown-item" onclick="changeItem('m_start','11')">11</span>
				  <span class="dropdown-item" onclick="changeItem('m_start','12')">12</span>	
              </div>			  
            </li>
			<li class="nav-item dropdown">              
			  <a class="nav-link dropdown-toggle active" href="#" id="y_end" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">結束 2019</a>
			  <div class="dropdown-menu shadow border-0 " aria-labelledby="y_end">
				  <span class="dropdown-item" onclick="changeItem('y_end','2017')">2017</span>
				  <span class="dropdown-item" onclick="changeItem('y_end','2018')">2018</span>
				  <span class="dropdown-item" onclick="changeItem('y_end','2019')">2019</span> 
              </div>
            </li>  			
            <li class="nav-item dropdown">              
			  <a class="nav-link dropdown-toggle active" href="#" id="m_end" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">05</a>
			  <div class="dropdown-menu shadow border-0 " aria-labelledby="m_end">
				  <span class="dropdown-item" onclick="changeItem('m_end','01')">01</span>
				  <span class="dropdown-item" onclick="changeItem('m_end','02')">02</span>
				  <span class="dropdown-item" onclick="changeItem('m_end','03')">03</span>
				  <span class="dropdown-item" onclick="changeItem('m_end','04')">04</span>
				  <span class="dropdown-item" onclick="changeItem('m_end','05')">05</span>
				  <span class="dropdown-item" onclick="changeItem('m_end','06')">06</span>
				  <span class="dropdown-item" onclick="changeItem('m_end','07')">07</span>
				  <span class="dropdown-item" onclick="changeItem('m_end','08')">08</span>
				  <span class="dropdown-item" onclick="changeItem('m_end','09')">09</span>
				  <span class="dropdown-item" onclick="changeItem('m_end','10')">10</span>
				  <span class="dropdown-item" onclick="changeItem('m_end','11')">11</span>
				  <span class="dropdown-item" onclick="changeItem('m_end','12')">12</span>	
              </div>			  
            </li>
			<li class="nav-item">			
				<button style="height:85%;margin-top:3px;margin-left:20px;" type="button" id="downloadSearch" onclick="downloadSearch();" class="btn btn-outline-primary">搜尋結果下載</button>
			</li>
			<a href="#" id="downloader" style="display:none" download="sample.xlsx"></a>
			<input id="ym_end" style="display:none" value="">
			 
          </ul>
        </div-->
      </div>
    </nav>

    <!-- Page Content -->
    <div class="container" style=" margin-top:0px;height:100%;width:100%;">

      <div class="row"style="height:100%;width:100%;">

        <!-- Blog Entries Column -->
		
		
        <div class="col-md-8" style="  height:100%;width:1600px;">
		
          <!-- Blog Post -->
		    
			<div class="card mb-4" style="height:100%; margin-top:30px;margin-left:-50px">
			<table class="table table-bordered scrolltable"> 
				<thead style="display:block;overflow-y: scroll;border-bottom:1px solid #eee;"> 
				<tr id="table_head">
					<th scope="col" style="width:70px;">no</th>
					  <th scope="col" style="width:100px;">工號</th>
					  <th scope="col" style="width:100px;">姓名</th>
					  <th scope="col" style="width:300px;">問題</th>  
					  <th scope="col" style="width:120px;">查詢時間</th>  
					  <th scope="col" style="width:135px;">sessionsId</th> 
					  <th scope="col" style="width:120px;">answerType</th> 
					  <th scope="col" style="width:100px;">app</th>
					  <th scope="col" style="width:110px;">yearmonth</th>  
					  <th scope="col" style="width:110px;">answerNo</th>
					  <th scope="col" style="width:100px;">feedback</th>
					  <th scope="col" style="width:140px;">feedbackText</th>
					  <th scope="col" style="width:110px;">lead1</th>
					  <th scope="col" style="width:110px;">lead2</th>  
					  <th scope="col" style="width:110px;">lead3</th>  
					  <th scope="col" style="width:350px;">答案</th>  
				</tr>
				</thead>
				<tbody id="tbody" style="display:block; max-height:780px;overflow-y: scroll;">				
			    </tbody>
			</table>
			 </div>
		    
        </div>
        
      </div>
      <!-- /.row -->

    </div> 
</body>
</html>

<script type="text/javascript">
 

function parse_query_string(query) {
  var vars = query.split("&");
  var query_string = {};
  for (var i = 0; i < vars.length; i++) {
	var pair = vars[i].split("=");
	var key = decodeURIComponent(pair[0]);
	var value = decodeURIComponent(pair[1]);
	if (typeof query_string[key] === "undefined") {
	  query_string[key] = decodeURIComponent(value);
	} else if (typeof query_string[key] === "string") {
	  var arr = [query_string[key], decodeURIComponent(value)];
	  query_string[key] = arr;
	} else {
	  query_string[key].push(decodeURIComponent(value));
	}
  }
  return query_string;
}
 
</script> 